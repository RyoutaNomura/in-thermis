<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./resource-location.html">

<dom-module id="search-result-card"> <template>
<div class="header container flex-horizontal">
  <div class="resource-name">
    <span>{{resourceName}}</span> <span class="resource-key">{{keys}}</span>
  </div>
  <div class="flexchild"></div>
  <div class="date">{{resourceModified}}</div>
</div>

<div class="content font-mincho">
  <div>{{prevContent}}</div>
  <div id='content'></div>
  <div>{{nextContent}}</div>
</div>

<div class="footer">
  <resource-location
    uri={{uri}}
    resource-size={{resourceSize}}
    resource-type-name={{resourceTypeName}}
    resource-icon={{resourceIcon}}
    indexer-class-name={{indexerClassName}}></resource-location>
</div>

</template>

<style>
:host {
  display: block;
  background-color: white;
  padding: 10px 14px 10px 14px;
  box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0
    rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
}

.flex-horizontal { @apply (--layout-horizontal);}
.flexchild { @apply (--layout-flex);}

.header {
  border-bottom: solid 1px;
  padding: 7px 0;
}

.resource-name {
  font-weight: bold;
}

.resource-key {
  margin-left: 20px;
  font-size: small;
}

div.content {
  font-size: smaller;
  color: gray;
  padding: 10px 0;
}

div#content {
  color: black;
}

span.highlightend-text {
  background-color: yellow;
}

div.footer {
  border-top: dashed 1px gray;
  padding-top: 10px;
}

</style>

<script>
	Polymer({
		is : "search-result-card",
		properties : {
			uri : String,
			resourceName : String,
			resourceSize : Number,
			resourceTypeName : String,
			resourceCreated : Date,
			resourceModified : Date,
			keys : String,
			content : {
				type: String,
				observer: 'contentChanged',
			},
			prevContent: String,
			nextContent: String,
			positions : Array,
			indexerClassName: String,
			indexGenerated : Date,
		},
		contentChanged: function() {
			if (typeof this.content === 'undefined') return;
			if (typeof this.positions ==='undefined') return;

			// 検索結果の該当箇所をspan要素を利用して色付けする。
			var html = this.content;
			this.positions.sort(function(a,b) {
				return  b[0] - a[0];
			})
			this.positions.forEach(function(val, index, ar){
				var start = val[0];
				var length = val[1];
				html = html.substr(0, start) + 
					"<span class='highlightend-text'>" + 
					html.substr(start, length) + "</span>" + 
					html.substr(start+length, html.length);
			});
			html = html.replace(/[\n\r]/g,"</br>")
			// エスケープされるのを防ぐために、DOMを直接操作する(※サーバーサイドでやるべきか)
			Polymer.dom(this.$.content).innerHTML = html;
		}
	});
</script> </dom-module>
